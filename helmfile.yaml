---
repositories:
  - name: stable
    url: https://charts.helm.sh/stable

environments:
  default:
    values:
    - config/dev.env.yaml
    - values/dev.yaml
  dev:
    values:
    - config/dev.env.yaml
    - values/dev.yaml

helmDefaults:
  wait: false
  createNamespace: true
  timeout: 600

releases:
  - name: dealsheet-api
    namespace: {{ .Values.dealsheet.namespace }}
    chart: ./charts/dealsheet-api
    values:
      - ./charts/dealsheet-api/values-{{ requiredEnv "CLUSTER_NAME" }}.yaml
      - projectId: {{ .Values.env.GCLOUD_PROJECT }}
    hooks:
      - events: ['postsync']
        showlogs: true
        command: 'kubectl'
        args: ['label', 'ns', '{{ .Values.dealsheet.namespace }}', 'istio.io/rev={{ .Values.istio.revision }}', '--overwrite=true']
  - name: calendar-api
    namespace: {{ .Values.calendar.namespace }}
    chart: ./charts/calendar-api
    values:
      - ./charts/calendar-api/values-{{ requiredEnv "CLUSTER_NAME" }}.yaml
      - projectId: {{ .Values.env.GCLOUD_PROJECT }}
    hooks:
      - events: ['postsync']
        showlogs: true
        command: 'kubectl'
        args: ['label', 'ns', '{{ .Values.calendar.namespace }}', 'istio.io/rev={{ .Values.istio.revision }}', '--overwrite=true']         
  - name: hierarchy-api
    namespace: {{ .Values.hierarchy.namespace }}
    chart: ./charts/hierarchy-api
    values:
      - ./charts/hierarchy-api/values-{{ requiredEnv "CLUSTER_NAME" }}.yaml
      - projectId: {{ .Values.env.GCLOUD_PROJECT }}
    hooks:
      - events: ['postsync']
        showlogs: true
        command: 'kubectl'
        args: ['label', 'ns', '{{ .Values.hierarchy.namespace }}', 'istio.io/rev={{ .Values.istio.revision }}', '--overwrite=true']
  - name: graphql-mesh
    namespace: {{ .Values.graphql.namespace }}
    chart: ./charts/graphql-mesh
    values:
      - ./charts/graphql-mesh/values-{{ requiredEnv "CLUSTER_NAME" }}.yaml
    hooks:
      - events: ['postsync']
        showlogs: true
        command: 'kubectl'
        args: ['label', 'ns', '{{ .Values.graphql.namespace }}', 'istio.io/rev={{ .Values.istio.revision }}', '--overwrite=true']       
  - name: istio
    chart: ./charts/istio
    namespace: {{ .Values.istio.namespace }}
    values:
      - ./charts/istio/values-{{ requiredEnv "CLUSTER_NAME" }}.yaml
    hooks:
      - events: ['postsync']
        showlogs: true
        command: 'kubectl'
        args: ['label', 'ns', '{{ .Values.istio.namespace }}', 'istio.io/rev={{ .Values.istio.revision }}', '--overwrite=true']
      - events: ['postuninstall']
        showlogs: true
        command: 'kubectl'
        args: ['delete', 'ns', '{{ .Values.istio.namespace }}']
